{% load static %}
<!DOCTYPE html>
<!-- Presenta el proceso de checkout y resumen del carrito. -->
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EpicAnimes | Carrito</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'css/base/index.css' %}?v=4">
  <link rel="stylesheet" href="{% static 'css/pages/cart.css' %}?v=1">
  <link rel="stylesheet" href="{% static 'css/base/chatbot.css' %}?v=2">
  {% include 'includes/favicons.html' %}
</head>
<body class="cart-body"
      data-paypal-enabled="{{ paypal_enabled|yesno:'true,false' }}"
      data-paypal-error="{{ paypal_error|default:''|escape }}"
      data-paypal-currency="{{ paypal_order_currency|default:paypal_currency|default:'CLP' }}">
  <canvas id="stars" aria-hidden="true"></canvas>
  {% include 'includes/navbar.html' with nav_page='carrito' %}

  <main class="cart-page">
    <section class="glass cart-header">
      <div>
        <p class="cart-header__pill"><i class="fa fa-bolt"></i> Checkout seguro</p>
        <h1>Tu carrito</h1>
        <p class="muted">Confirma tu pedido y completa los datos para liberar el pago con PayPal.</p>
      </div>
    </section>

    {% if messages %}
      <div class="messages cart-messages">
        {% for message in messages %}
          <div class="message message--{{ message.tags|default:'info' }}">
            <i class="fa fa-circle-info"></i>
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if items %}
      <section class="glass cart-items">
        <ul class="cart-items__list list-unstyled d-flex flex-column gap-3">
          {% for item in items %}
            {% with producto=item.producto %}
              <li class="cart-item-card" data-product-id="{{ producto.id }}" data-update-url="{% url 'carrito_actualizar' producto.id %}">
                <div class="cart-item-info">
                  <img src="{{ item.imagen_url }}" alt="{{ producto.nombre }}" class="cart-item-thumb">
                  <div>
                    <h5>{{ producto.nombre }}</h5>
                    <div class="meta">{{ producto.marca }} | {{ producto.categoria }}</div>
                    <div class="price">Precio unitario: ${{ producto.precio|floatformat:0 }}</div>
                    {% if not item.stock_suficiente %}
                      <div class="cart-item-card__stock"><i class="fa fa-exclamation-circle"></i> Stock disponible: {{ producto.existencias }}</div>
                    {% endif %}
                  </div>
                </div>
                <div class="quantity-box">
                  <label for="qty-{{ producto.id }}">Cantidad</label>
                  <input
                    id="qty-{{ producto.id }}"
                    type="number"
                    class="form-control form-control-sm js-cart-qty"
                    value="{{ item.cantidad }}"
                    min="1"
                    max="{{ producto.existencias }}"
                    data-product-id="{{ producto.id }}"
                    {% if not puede_comprar %}disabled{% endif %}>
                </div>
                <div class="cart-item-subtotal text-end">
                  <div class="meta">Subtotal</div>
                  <strong>$ <span class="js-item-subtotal" data-product-id="{{ producto.id }}">{{ item.subtotal|floatformat:0 }}</span></strong>
                  <div class="cart-item-actions">
                    <form id="remove-form-{{ producto.id }}" method="post" action="{% url 'carrito_eliminar' producto.id %}">
                      {% csrf_token %}
                      <button type="button" class="btn btn-link text-danger p-0 js-cart-remove" data-product-id="{{ producto.id }}">Eliminar</button>
                    </form>
                  </div>
                </div>
              </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </section>

      <section class="cart-checkout">
        <div class="glass cart-form-block">
          <h4 class="mb-3">Datos de envío</h4>
          <form id="checkoutForm" class="cart-form" novalidate>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="checkoutNombre">Nombre completo</label>
                <input type="text" id="checkoutNombre" name="nombre" class="form-control" value="{{ checkout_prefill.nombre }}" placeholder="Tu nombre" {% if not puede_comprar %}disabled{% endif %}>
                <div class="invalid-feedback">Ingresa tu nombre completo.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="checkoutEmail">Correo electrónico</label>
                <input type="email" id="checkoutEmail" name="email" class="form-control" value="{{ checkout_prefill.email }}" placeholder="tu@correo.com" {% if not puede_comprar %}disabled{% endif %}>
                <div class="invalid-feedback">Ingresa un correo válido.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="checkoutTelefono">Teléfono</label>
                <input type="text" id="checkoutTelefono" name="telefono" class="form-control" value="{{ checkout_prefill.telefono }}" placeholder="+56 9 1234 5678" {% if not puede_comprar %}disabled{% endif %}>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="checkoutDireccion">Dirección</label>
                <input type="text" id="checkoutDireccion" name="direccion" class="form-control" value="{{ checkout_prefill.direccion }}" placeholder="Calle 123, depto 45" {% if not puede_comprar %}disabled{% endif %}>
                <div class="invalid-feedback">Ingresa la dirección de entrega.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="checkoutCiudad">Ciudad</label>
                <input type="text" id="checkoutCiudad" name="ciudad" class="form-control" value="{{ checkout_prefill.ciudad }}" placeholder="Ciudad" {% if not puede_comprar %}disabled{% endif %}>
                <div class="invalid-feedback">Indica la ciudad.</div>
              </div>
              <div class="col-12">
                <label class="form-label" for="checkoutNotas">Notas para el envío (opcional)</label>
                <textarea id="checkoutNotas" name="notas" class="form-control custom-placeholde" rows="3" placeholder="Ej: dejar en conserjería" {% if not puede_comprar %}disabled{% endif %}>{{ checkout_prefill.notas }}</textarea>
              </div>
            </div>
          </form>
        </div>

        <div class="glass cart-summary-card">
          <h4>Resumen</h4>
          <p class="text-white small">Total a pagar</p>
          <p class="fs-3 fw-semibold mb-1">$ <span id="cartTotalAmount" data-total-raw="{{ total }}">{{ total|floatformat:0 }}</span></p>

          {% if paypal_uses_conversion %}
            {% if paypal_conversion_is_fallback %}
              <p class="text-warning small mb-2">
                Usamos la tasa manual configurada: 1 {{ paypal_order_currency }} = {{ paypal_conversion_rate_display }} {{ paypal_currency }}.
              </p>
            {% else %}
              <p class="text-muted small mb-2">
                Se procesará el pago en {{ paypal_order_currency }}.
                {% if paypal_order_estimate %}
                  Aproximadamente
                  <strong><span id="paypalConvertedAmount" data-rate="{{ paypal_conversion_rate }}" data-order-currency="{{ paypal_order_currency }}">{{ paypal_order_estimate|floatformat:2 }}</span> {{ paypal_order_currency }}</strong>.
                {% endif %}
                (1 {{ paypal_order_currency }} = {{ paypal_conversion_rate_display }} {{ paypal_currency }}).
              </p>
            {% endif %}
          {% endif %}

          <div id="checkoutAlerts">
            {% if not puede_comprar %}
              <div class="alert alert-warning" role="alert">Debes iniciar sesión como comprador para finalizar la compra.</div>
            {% elif not puede_pagar %}
              <div class="alert alert-warning" role="alert">Ajusta las cantidades para continuar. Hay productos sin stock suficiente.</div>
            {% elif not paypal_enabled %}
              <div class="alert alert-warning" role="alert">{{ paypal_error }}</div>
            {% endif %}
          </div>

          <div id="paypalWrapper" class="{% if not puede_pagar_paypal %}d-none{% endif %}">
            <div id="paypal-button-container"></div>
          </div>

          {% if request.user.is_authenticated %}
            <button
              type="button"
              id="fakeCheckoutBtn"
              class="btn btn--ghost fake-checkout-btn mt-2"
              data-simulate-url="{% url 'carrito_simular' %}"
            >
              <i class="fa fa-magic"></i>    Comprar (ficticia) 
            </button>
          {% endif %}

          <p class="text-white small mb-0">Tus datos se almacenan de forma segura y solo se usan para este despacho.</p>
        </div>
      </section>
    {% else %}
      <section class="glass cart-empty">
        <i class="fa fa-cart-shopping fa-2x"></i>
        <p>Tu carrito está vacío. Explora nuevas figuras y coleccionables en el catálogo.</p>
        <a href="{% url 'index' %}#catalogo">Volver al inicio</a>
      </section>
    {% endif %}
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/site/cart.js' %}?v=1"></script>
  {% if puede_pagar_paypal and paypal_client_id %}
    <script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id|urlencode }}&currency={{ paypal_order_currency|default:paypal_currency|default:'CLP' }}&intent=capture"></script>
    <script>
      (function() {
        if (!window.cartPage || !window.paypal) return;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const createOrderUrl = '{% url 'carrito_paypal_create_order' %}';

        paypal.Buttons({
          style: { layout: 'vertical', shape: 'pill', color: 'gold', label: 'paypal' },
          onClick: function(data, actions) {
            const result = window.cartPage.collectCheckoutData();
            if (!result.ok) {
              window.cartPage.showFormErrors(result.errors);
              return actions.reject();
            }
            window.cartPage.setLastCheckoutData(result.data);
            return actions.resolve();
          },
          createOrder: function() {
            const info = window.cartPage.lastCheckoutData || {};
            return fetch(createOrderUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify({ datos_cliente: info })
            })
            .then((response) => response.json())
            .then((result) => {
              if (result && result.ok && result.orderID) {
                return result.orderID;
              }
              const message = (result && result.error) || 'No se pudo inicializar el pago.';
              throw new Error(message);
            })
            .catch((err) => {
              console.error('[cart] paypal createOrder', err);
              throw err;
            });
          },
          onApprove: function(data) {
            const payload = {
              paypal_order_id: data.orderID,
              datos_cliente: window.cartPage.lastCheckoutData || {}
            };
            return fetch('{% url 'carrito_checkout' %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
              if (result.ok) {
                window.location.href = result.redirect;
              } else {
                window.cartPage.showCheckoutError(result.error || 'No se pudo completar el pago.');
              }
            })
            .catch((err) => {
              console.error('[cart] paypal onApprove', err);
              window.cartPage.showCheckoutError('No se pudo completar el pago.');
            });
          },
          onError: function(err) {
            console.error('[cart] paypal onError', err);
            const message = (err && err.message) ? err.message : 'No se pudo inicializar el pago.';
            window.cartPage.showCheckoutError(message);
          }
        }).render('#paypal-button-container');
      })();
    </script>
  {% endif %}

  {% include 'includes/chatbot_popup.html' %}
  <script defer src="{% static 'js/site/chatbot.js' %}?v=2"></script>
</body>
</html>
