{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ producto.nombre }} | EpicAnimes</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/index.css' %}?v=3">
  <link rel="stylesheet" href="{% static 'css/chatbot.css' %}?v=2">
  <style>
    .product-detail { max-width: 1180px; margin: 0 auto; padding: 40px 20px 80px; }
    .product-detail__layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; align-items: flex-start; margin-bottom: 60px; }
    .product-detail__image { border-radius: 24px; border: var(--border); box-shadow: var(--shadow); background: #f0f2f7; overflow: hidden; }
    .product-detail__image img { width: 100%; display: block; }
    .product-detail__info h1 { font-size: 2.4rem; font-weight: 700; margin-bottom: 16px; color: var(--text); }
    .product-detail__info p { color: var(--muted); font-size: 1rem; margin-bottom: 16px; }
    .product-detail__meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin: 20px 0 30px; }
    .product-detail__meta span { padding: 10px 14px; border-radius: 12px; border: var(--border); background: var(--surface); font-weight: 600; font-size: 0.95rem; color: var(--text); display: inline-flex; align-items: center; gap: 6px; }
    .product-detail__meta span i { color: var(--accent); }
    .related-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
    .related-card { padding: 18px; border-radius: var(--radius); border: var(--border); background: var(--surface); box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .related-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12); }
    .related-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; border: var(--border); background: #f0f2f7; }
    .related-card h5 { margin-top: 14px; margin-bottom: 6px; font-size: 1rem; color: var(--text); }
    .breadcrumbs { font-size: 0.85rem; color: var(--muted); margin-bottom: 14px; }
    @media (max-width: 768px) { .product-detail { padding-top: 120px; } .product-detail__info h1 { font-size: 2rem; } }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container-main d-flex align-items-center justify-content-between">
      <a class="navbar-brand me-3" href="{% url 'index' %}">EpicAnimes</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav align-items-lg-center me-auto mb-3 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{% url 'index' %}">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'sobre_nosotros' %}">Sobre nosotros</a></li>
          <li class="nav-item"><a class="nav-link active" href="{% url 'index' %}#productos">Catálogo</a></li>
          <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'contacto' %}active{% endif %}" href="{% url 'contacto' %}">Contáctanos</a></li>
        </ul>
        <a class="cart-btn" href="{% url 'carrito' %}">
          <i class="fa fa-shopping-cart"></i>
          <span class="cart-count">{{ cart_count }}</span>
        </a>
      </div>
    </div>
  </nav>

  <main class="product-detail">
    <div class="breadcrumbs">
      <a href="{% url 'index' %}">Inicio</a> ›
      <a href="{% url 'index' %}#productos">Catálogo</a> ›
      <span>{{ producto.nombre }}</span>
    </div>

    <section class="product-detail__layout">
      <div class="product-detail__image">
        <img src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}">
      </div>
      <div class="product-detail__info">
        <h1>{{ producto.nombre }}</h1>
        <p>{{ producto.descripcion|default:"Este producto aún no tiene una descripcin detallada." }}</p>
        <div class="product-detail__meta">
          <span><i class="fa fa-store"></i> {{ producto.marca }}</span>
          <span><i class="fa fa-layer-group"></i> {{ producto.categoria }}</span>
          <span><i class="fa fa-diamond"></i> {{ producto.calidad }}</span>
          <span><i class="fa fa-chart-bar"></i> Stock: {{ producto.existencias }}</span>
        </div>
        {% if vendedor_nombre %}
          <p class="small text-muted">Vendido por <strong>{{ vendedor_nombre }}</strong></p>
        {% endif %}
        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-3 mt-3">
          <span class="price fs-3">${{ producto.precio|floatformat:0 }}</span>
          {% if producto.existencias > 0 %}
            {% if puede_comprar %}
              <form method="post" action="{% url 'carrito_agregar' producto.id %}" class="d-flex align-items-center gap-3">
                {% csrf_token %}
                <input class="form-control" type="number" name="cantidad" value="1" min="1" max="{{ producto.existencias }}" data-quantity-max="{{ producto.existencias }}" style="width:110px;">
                <button type="submit" class="btn btn-light"><i class="fa fa-cart-plus"></i> Agregar al carrito</button>
              </form>
            {% elif request.user.is_authenticated %}
              <div class="d-flex flex-column flex-sm-row gap-2 align-items-sm-center text-warning small fw-semibold">
                <input class="form-control" type="number" value="1" min="1" max="{{ producto.existencias }}" disabled style="width:110px;">
                <span class="flex-grow-1 text-center bg-warning-subtle rounded-pill py-1 px-3">Solo perfiles compradores</span>
              </div>
            {% else %}
              <div class="d-flex flex-column flex-sm-row gap-2 align-items-sm-center">
                <input class="form-control" type="number" value="1" min="1" max="{{ producto.existencias }}" disabled style="width:110px;">
                <button type="button"
                        class="btn btn-light require-auth"
                        data-login-url="{% url 'login' %}?next={% url 'producto_detalle' producto.id %}"
                        data-message="Necesitas iniciar sesin para agregar productos al carrito. Vamos al acceso.">
                  <i class="fa fa-right-to-bracket"></i> Iniciar sesin
                </button>
              </div>
            {% endif %}
          {% else %}
            <span class="badge bg-danger">Sin stock disponible</span>
          {% endif %}
        </div>
      </div>
    </section>

    {% if relacionados %}
      <section>
        <h2 class="mb-3">También te puede interesar</h2>
        <div class="related-grid">
          {% for rel in relacionados %}
            <a class="related-card" href="{% url 'producto_detalle' rel.id %}">
              <img src="{{ rel.imagen_url }}" alt="{{ rel.nombre }}">
              <h5>{{ rel.nombre }}</h5>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <span class="price">${{ rel.precio|floatformat:0 }}</span>
                <span class="badge bg-light text-dark">{{ rel.marca }}</span>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </main>

  <footer>
    <div class="container-main text-center text-md-start">
      <p class="text-center text-muted mt-4 mb-0">&copy; <span id="currentYear"></span> EpicAnimes. Todos los derechos reservados.</p>
    </div>
  </footer>

  {% include 'includes/chatbot_popup.html' %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/index.js' %}"></script>
  <script defer src="{% static 'js/chatbot.js' %}?v=2"></script>
  <script>
    try { document.getElementById('currentYear').textContent = new Date().getFullYear(); } catch (err) {}
  </script>
</body>
</html>
