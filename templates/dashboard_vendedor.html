{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EpicAnimes - Panel Vendedor</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/dashboard_vendedor.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="{% static 'js/dashboard_vendedor.js' %}"></script>
  <script defer src="{% static 'js/dashboard_vendedor_charts.js' %}"></script>
</head>

<body class="theme-cool">
  <div class="dashboard-container">
    <aside class="sidebar">
      <a class="logo" href="{% url 'index' %}"><i class="fas fa-hat-wizard"></i> EpicAnimes</a>
      <nav>
        <a data-section="bienvenido" class="active"><i class="fas fa-handshake"></i> Bienvenido, {{ request.user.username }}</a>
        <a data-section="ventas"><i class="fas fa-chart-line"></i> Vendedor</a>
        <a data-section="stock"><i class="fas fa-warehouse"></i> Control de Stock</a>
        <a data-section="productos"><i class="fas fa-box"></i> Productos</a>
        <a href="{% url 'index' %}"><i class="fas fa-sign-out-alt"></i> Salir</a>
      </nav>
    </aside>

    <main class="content">
      <h1>Panel de Control</h1>

      <!-- SecciÃ³n de bienvenida al vendedor -->
      <section id="bienvenido" class="section-group active">
        <h2 class="section-title"><i class="fas fa-user-tie"></i> Hola, {{ request.user.username }}</h2>
        <div class="kpi-grid">
          <div class="kpi-card">
            <i class="fas fa-user icon-large"></i>
            <div class="data">
              <p class="title">Usuario</p>
              <span class="secction-tittle"><h2>{{ request.user.username }}</h2></span>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-envelope icon-large"></i>
            <div class="data">
              <p class="title">Email</p>
              <span class="secction-email"><h2>{{ request.user.email|default:'-' }}</h2></span>
            </div>
          </div>
        </div>
        <br>
        <div class="chart-card">
          <h3 class="card-title">Accesos rápidos</h3>
          <p class="hint">Administra tu inventario y agrega nuevos productos desde aquí<br><br></p>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'ventas\']').click(); return false;"><i class="fas fa-chart-line"></i> Ir a Vendedor</a>
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'stock\']').click(); return false;"><i class="fas fa-warehouse"></i> Ir a Stock</a>
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'productos\']').click(); return false;"><i class="fas fa-box"></i> Ir a Productos</a>
            <a class="btn" href="{% url 'index' %}"><i class="fas fa-sign-out-alt"></i> Salir</a>
          </div>
        </div>
      </section>

      <section id="ventas" class="section-group">
        <h2 class="section-title"><i class="fas fa-star"></i> Rendimiento de Venta</h2>
        <div class="kpi-grid">
          <div class="kpi-card">
            <i class="fas fa-hand-holding-usd icon-large"></i>
            <div class="data">
              <p class="title">Ventas Hoy</p>
              <span class="value" id="kpiVentasHoy">$0</span>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-receipt icon-large"></i>
            <div class="data">
              <p class="title">Ticket Promedio</p>
              <span class="value" id="kpiTicket">$0</span>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-percentage icon-large"></i>
            <div class="data">
              <p class="title">Tasa Conversión</p>
              <span class="value" id="kpiTasa">--</span>
            </div>
          </div>
        </div>
        <br>
        <div class="chart-card">
          <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between;">
            <div>
            <label for="ventasRangeSel" class="chart-filter-label">Rango:</label>
            <div class="chip-group" data-select="#ventasRangeSel" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
              <a href="#" class="btn ghost" data-value="7">7 días</a>
              <a href="#" class="btn ghost" data-value="14">14 días</a>
              <a href="#" class="btn ghost" data-value="30">30 días</a>
            </div>
            <select id="ventasRangeSel" class="chart-filter-select" style="height: 4vh; display:none;">
              <option value="7">7 días</option>
              <option value="14">14 días</option>
              <option value="30" selected>30 días</option>
            </select>
            </div>
            <div class="btn-group" role="group" aria-label="Tipo de gráfico" style="display:flex; gap:8px;">
              <button type="button" id="btnGrafLinea" class="btn primary">Línea</button>
              <button type="button" id="btnGrafBarras" class="btn">Barras</button>
              <button type="button" id="btnGrafPie" class="btn">Circular</button>
            </div>
          </div>
        </div>

        <div class="chart-card" id="cardGrafLinea">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <h3 class="card-title" id="tituloLineaText">Ventas (línea)</h3>
            <div>
              <label for="tituloLineaSel" class="chart-filter-label"></label>
              <a id="tituloLineaSel" class="chart-filter-select" style="height: 4vh;">
                <a value="Tendencia de ventas"></a>
              </a>
            </div>
          </div>
          <div class="chart-area"><canvas id="chartVendedorLinea"></canvas></div>
        </div>

        <div class="chart-card" id="cardGrafBarras" style="display:none;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <h3 class="card-title" id="tituloBarrasText">Ventas por día (barras)</h3>
            <div>
              <label for="tituloBarrasSel" class="chart-filter-label"></label>
              <a id="tituloBarrasSel" class="chart-filter-select" style="height: 4vh;">
                <a value="Ventas por día"></a>
              </a>
            </div>
          </div>
          <div class="chart-area"><canvas id="chartVendedorBarras"></canvas></div>
        </div>

        <div class="chart-card" id="cardGrafPie" style="display:none;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <h3 class="card-title" id="tituloPieText">Top categorías</h3>
          </div>
          <div class="chart-area"><canvas id="chartVendedorPie"></canvas></div>
        </div>
      </section>

      <section id="stock" class="section-group">
        <h2 class="section-title"><i class="fas fa-warehouse"></i> Control de Stock</h2>
        <div class="kpi-grid">
          <!-- Resumen -->
          <div class="kpi-card">
            <i class="fas fa-boxes icon-large"></i>
            <div class="data">
              <p class="title">Valor Total Stock</p>
              <span class="value" id="kpiValorStock">$0</span>
            </div>
          </div>
          <div class="kpi-card alerta-critica">
            <i class="fas fa-exclamation-triangle icon-large"></i>
            <div class="data">
              <p class="title">Productos Críticos</p>
              <span class="value" id="kpiCriticos">0</span>
            </div>
          </div>
        </div>

        <br>
        <div id="alertaCriticosBanner" class="alert-banner" style="display:none;">
          <i class="fas fa-envelope-open-text alert-banner__icon"></i>
          <div class="alert-banner__content">
            <strong>Correo enviado.</strong>
            <span id="alertaCriticosTexto">Te enviamos un correo con el detalle de los productos críticos detectados.</span>
          </div>
        </div>

        <!-- Productos a Reponer (debajo de KPIs) -->
        <div class="chart-card">
            <div style="display:grid; gap:10px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <h3 class="card-title" style="margin:0">Productos a Reponer</h3>
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap">
                  <label style="color:var(--color-subtexto); font-size:.9em">Umbral crítico
                    {% with umbral_actual=umbral_critico|default:5 %}
                    <select id="stock_umbral" class="form-control" data-default-umbral="{{ umbral_actual }}" style="min-width:90px; background:#291E34;color:#eaf2ff; border:1px solid #58283F; font-weight:600;">
                      <option value="3" {% if umbral_actual == 3 %}selected{% endif %}>Crítico en 3</option>
                      <option value="5" {% if umbral_actual == 5 %}selected{% endif %}>Crítico en 5</option>
                    </select>
                    {% endwith %}
                  </label>


                  <button type="button" class="btn info" id="btnRefrescarStock"><i class="fas fa-sync"></i> Actualizar</button>
                  <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'productos\']').click(); return false;"><i class="fas fa-plus"></i> Agregar Producto</a>
                  
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <input id="stock_buscar" type="text" class="form-control" placeholder="Buscar por nombre..." style="min-width:220px">
                <select id="stock_categoria" class="form-control" style="background:#291E34;color:#eaf2ff; border:1px solid #58283F;">
                  <option value="" style="background-color: bisque;color:#03160b; font-weight:600">Todas las categorías</option>
                </select>
                <button type="button" class="btn" id="btnCopiarCriticos"><i class="fas fa-clipboard"></i> Copiar lista crítica</button>
              </div>
            </div>

            <br>
            <table class="data-table" id="tablaStockVendedor">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Stock</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <!-- Resumen por categorí­a -->
            <div id="stockResumenCategorias" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px"></div>
          </div>
      </section>

      <section id="productos" class="section-group">
        {% if messages %}
        {% for message in messages %}
        {% if message == 'Producto actualizado correctamente.' %}
        <div class="chart-card message-card">
          <ul class="messages-list">
            <li class="message-item success">
              <i class="fas fa-check-circle message-icon success"></i>
              <span>{{ message }}</span>
            </li>
          </ul>
        </div>
        {% endif %}
          <option value="Alternativo" {% if form_data.marca == 'Alternativo' %}selected{% endif %}>Alternativo</option>
        {% endfor %}
        {% endif %}
        <h2 class="section-title"><i class="fas fa-box"></i> Gestión de Productos</h2>

        <div class="chart-card">
          <h3 class="card-title" >Importar / Exportar inventario</h3>
          <table class="data-table">
            <thead>
              <tr><th>Acciones</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input type="file" id="excelProductos" accept=".xlsx,.csv" class="form-control" style="display:none;">
                  <button type="button" class="btn primary" id="btnImportExcel"><i class="fas fa-file-import"></i> Importar Excel</button>
                  <a class="btn primary" href="{% url 'export_vendedor_inventario_xlsx' %}"><i class="fas fa-file-export"></i> Exportar Excel</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <br>

        <div class="chart-card register-card">
          <h3 class="card-title">Registrar nuevo producto</h3>
          
          <!-- Controles de Importar/Exportar movidos a la tarjeta superior -->
          <form id="formAgregarProducto" method="POST" enctype="multipart/form-data" action="{% url 'dashboard_vendedor' %}" class="product-form">
            {% csrf_token %}
            <input type="hidden" name="producto_id" id="producto_id" value="">
            
            <!-- Seccion 1: Imagen -->
            <table class="data-table register-table">
              <thead>
                <tr>
                  <th>Seleccionar imagen</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input id="imagen" type="file" name="imagen" accept="image/*" required class="form-control"></td>
                </tr>
              </tbody>
            </table>

            <!-- Seccion 2: Datos principales -->
            <table class="data-table register-table" style="margin-top:10px;">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Marca</th>
                  <th>Calidad</th>
                  <th>Categoria</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input id="nombre" type="text" name="nombre" value="{{ form_data.nombre|default:'' }}" required class="form-control" placeholder="Nombre"></td>
                  <td>
                    <select id="marca" name="marca" class="form-control" style="background:#291E34;color:#eaf2ff; border:1px solid #58283F;" required>
                    <option value="">Selecciona</option>
                      {% if form_data.marca %}
                        <option value="{{ form_data.marca }}" selected>{{ form_data.marca }}</option>
                      {% endif %}
                      <option value="Alternativo" {% if form_data.marca == 'Alternativo' %}selected{% endif %}>Alternativo</option>
                      <option value="Bandai" {% if form_data.marca == 'Bandai' %}selected{% endif %}>Bandai</option>
                      <option value="Banpresto" {% if form_data.marca == 'Banpresto' %}selected{% endif %}>Banpresto</option>
                      <option value="SEGA" {% if form_data.marca == 'SEGA' %}selected{% endif %}>SEGA</option>
                      <option value="Sega Prize" {% if form_data.marca == 'Sega Prize' %}selected{% endif %}>Sega Prize</option>
                      <option value="Maximatic" {% if form_data.marca == 'Maximatic' %}selected{% endif %}>Maximatic</option>
                      <option value="Good Smile Company" {% if form_data.marca == 'Good Smile Company' %}selected{% endif %}>Good Smile Company</option>
                      <option value="Furyu" {% if form_data.marca == 'Furyu' %}selected{% endif %}>Furyu</option>
                      <option value="Kotobukiya" {% if form_data.marca == 'Kotobukiya' %}selected{% endif %}>Kotobukiya</option>
                      <option value="Megahouse" {% if form_data.marca == 'Megahouse' %}selected{% endif %}>Megahouse</option>
                      <option value="Max Factory" {% if form_data.marca == 'Max Factory' %}selected{% endif %}>Max Factory</option>
                      <option value="Taito" {% if form_data.marca == 'Taito' %}selected{% endif %}>Taito</option>
                      <option value="Ichiban Kuji" {% if form_data.marca == 'Ichiban Kuji' %}selected{% endif %}>Ichiban Kuji</option>
                    </select>
                  </td>
                  <td>
                    <select id="calidad" name="calidad" required class="form-control" style="background:#291E34;color:#eaf2ff; border:1px solid #58283F;">
                      <option value="">Selecciona</option>
                      <option value="Original" {% if form_data.calidad == 'Original' %}selected{% endif %}>Original</option>
                      <option value="Alternativo" {% if form_data.calidad == 'Alternativo' %}selected{% endif %}>Alternativo</option>
                      
                    </select>
                  </td>
                  <td>
                    <select id="categoria" name="categoria" class="form-control" style="background:#291E34;color:#eaf2ff; border:1px solid #58283F;" required>
                      <option value="">Selecciona</option>
                      {% if form_data.categoria %}
                        <option value="{{ form_data.categoria }}" selected>{{ form_data.categoria }}</option>
                      {% endif %}

                      <option value="Peluches" {% if form_data.categoria == 'Peluches' %}selected{% endif %}>Peluches</option>
                      <option value="Figuras" {% if form_data.categoria == 'Figuras' %}selected{% endif %}>Figuras</option>
                      <option value="Llaveros" {% if form_data.categoria == 'Llaveros' %}selected{% endif %}>Llaveros</option>
                      <option value="Polerones" {% if form_data.categoria == 'Polerones' %}selected{% endif %}>Polerones</option>
                      <option value="Posters" {% if form_data.categoria == 'Posters' %}selected{% endif %}>Posters</option>
                      <option value="Tazas" {% if form_data.categoria == 'Tazas' %}selected{% endif %}>Tazas</option>
                      <option value="Accesorios" {% if form_data.categoria == 'Accesorios' %}selected{% endif %}>Accesorios</option>
                      {% for cat in categorias %}
                        {% with cat_lower=cat|lower %}
                          {% if cat_lower != 'figura' and cat_lower != 'figuras' %}
                            <option value="{{ cat }}" {% if form_data.categoria == cat %}selected{% endif %}>{{ cat }}</option>
                          {% endif %}
                        {% endwith %}
                      {% endfor %}
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Seccion 3: Precio y stock -->
            <table class="data-table register-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Precio</th>
                  <th>Existencias</th>
                  <th>Fecha ingreso</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><input id="precio" type="number" name="precio" step="0.01" min="0" value="{{ form_data.precio|default:'' }}" required class="form-control" placeholder="0.00"></td>
                  <td><input id="existencias" type="number" name="existencias" min="0" value="{{ form_data.existencias|default:'' }}" required class="form-control" placeholder="0"></td>
                  <td><input id="fecha_ingreso" type="date" name="fecha_ingreso" value="{{ form_data.fecha_ingreso|default:today }}" required class="form-control"></td>
                </tr>
              </tbody>
            </table>

            <!-- Seccion 4: Descripcion -->
            <table class="data-table register-table" style="margin-top:10px;">
              <thead>
                <tr>
                  <th>Descripción</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><textarea id="descripcion" name="descripcion" rows="2" required class="form-control form-control-textarea" placeholder="Breve descripcion">{{ form_data.descripcion|default:'' }}</textarea></td>
                </tr>
              </tbody>
            </table>

            <!-- Seccion 5: Accion -->
            <table id="tablaAccionSubmit" class="data-table register-table" style="margin-top:10px;">
              <thead>
                <tr>
                  <th id="thAccionForm">Guardar</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="blockSubmitForm">
                    <button type="submit" class="btn success" title="Guardar producto" id="btnSubmitForm">
                      <i class="fas fa-save"></i>
                      Guardar
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <datalist id="categorias-sugeridas">
              <option value="Peluches"></option>
              <option value="Llaveros"></option>
              <option value="Polerones"></option>
              <option value="Posters"></option>
              <option value="Tazas"></option>
              <option value="Accesorios"></option>
              {% for cat in categorias %}
              <option value="{{ cat }}"></option>
              {% endfor %}
            </datalist>
            <datalist id="marcas-sugeridas">
              <option value="Bandai"></option>
              <option value="Banpresto"></option>
              <option value="SEGA"></option>
              <option value="Sega Prize"></option>
              <option value="Maximatic"></option>
              <option value="Good Smile Company"></option>
              <option value="Furyu"></option>
              <option value="Kotobukiya"></option>
              <option value="Megahouse"></option>
              <option value="Max Factory"></option>
              <option value="Taito"></option>
              <option value="Ichiban Kuji"></option>
            </datalist>
            <table class="data-table action-table" id="tablaAccionesEdicion" style="display:none; margin-top:12px;">
              <thead>
                <tr><th>Cancelar Edición</th><th>Eliminar Producto</th><th>Guardar Producto</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><button type="button" class="btn info" id="btnCancelarEdicionTabla">Cancelar</button></td>
                  <td><button type="button" class="btn danger" id="btnEliminarProductoTabla"><i class="fas fa-trash"></i> Eliminar</button></td>
                  <td><button type="button" class="btn success" id="btnGuardarProductoTabla"><i class="fas fa-save"></i> Guardar</button></td>
                </tr>
              </tbody>
            </table>
          </form>
        </div>

        <br>

        <div class="chart-card inventory-card">
          <h3 class="card-title">Inventario</h3>
          <table class="data-table" id="tablaInventarioVendedor">
            <thead>
              <tr>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Marca</th>
                <th>Calidad</th>
                <th>Categoría</th>
                <th>Precio</th>
                <th>Existencias</th>
                <th>Fecha ingreso</th>
                <th>Descripción</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for producto in productos %}
              <tr>
                <td>
                  {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" style="width: 70px; height: 70px; object-fit: cover; border-radius: 8px;">
                  {% else %}
                    <span style="color: #99aab5;">Sin imagen</span>
                  {% endif %}
                </td>
                <td>{{ producto.nombre }}</td>
                <td>{{ producto.marca }}</td>
                <td>{{ producto.calidad }}</td>
                <td>{{ producto.categoria }}</td>
                <td>${{ producto.precio }}</td>
                <td>{{ producto.existencias }}</td>
                <td>{{ producto.fecha_ingreso|date:"d/m/Y" }}</td>
                <td>{{ producto.descripcion|default:'-'|truncatechars:80 }}</td>
                <td>
                  <button type="button"
                          class="btn ghost btn-edit"
                          title="Editar producto"
                          data-id="{{ producto.id }}"
                          data-nombre="{{ producto.nombre }}"
                          data-marca="{{ producto.marca }}"
                          data-calidad="{{ producto.calidad }}"
                          data-categoria="{{ producto.categoria }}"
                          data-precio="{{ producto.precio }}"
                          data-existencias="{{ producto.existencias }}"
                          data-fecha="{{ producto.fecha_ingreso|date:'Y-m-d' }}"
                          data-descripcion="{{ producto.descripcion }}">
                    Editar
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" style="text-align: center; color: #99aab5;">Aún no registras productos.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function(){
      function initChipGroup(group){
        const selRef = group.getAttribute('data-select');
        const select = selRef ? document.querySelector(selRef) : null;
        if (!select) return;
        const anchors = Array.from(group.querySelectorAll('a[data-value]'));
        const setActive = (val) => {
          anchors.forEach(a => {
            const isActive = a.getAttribute('data-value') === String(val);
            a.classList.toggle('success', isActive);
            a.classList.toggle('ghost', !isActive);
          });
        };
        anchors.forEach(a => a.addEventListener('click', (ev) => {
          ev.preventDefault();
          const val = a.getAttribute('data-value');
          if (!val) return;
          select.value = val;
          try { select.dispatchEvent(new Event('change', { bubbles:true })); }
          catch(_) { const e = document.createEvent('Event'); e.initEvent('change', true, true); select.dispatchEvent(e); }
          setActive(val);
        }));
        setActive(select.value || anchors[0]?.getAttribute('data-value'));
      }
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.chip-group[data-select]').forEach(initChipGroup);
      });
    })();
  </script>

</body>
</html>
