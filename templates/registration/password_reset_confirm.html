{% extends "registration/auth_base.html" %}
{% block title %}Nueva contraseña | EpicAnimes{% endblock %}

{% block auth_content %}
  <section class="auth-card glass">
    {% if validlink %}
      <div class="auth-card__header">
        <span class="pill"><i class="fa fa-shield-heart"></i> Enlace verificado</span>
        <h1>Define tu nueva contraseña</h1>
        <p>Introduce la nueva contraseña dos veces para confirmarla.</p>
      </div>
      <div class="auth-form-panel">
        <form method="post" class="auth-form" novalidate>
          {% csrf_token %}
          <div class="form-field">
            <label for="{{ form.new_password1.id_for_label }}"><i class="fa fa-lock"></i> Nueva contraseña</label>
            <div class="input-icon">
              <i class="fa fa-lock"></i>
              <input
                id="{{ form.new_password1.id_for_label }}"
                name="{{ form.new_password1.html_name }}"
                type="password"
                class="form-input"
                autocomplete="new-password"
                placeholder="Tu nueva contraseña"
                required>
              <span class="toggle-visibility" data-target="{{ form.new_password1.id_for_label }}"><i class="fa fa-eye"></i></span>
            </div>
            <ul class="requirement-list" id="resetRequirements">
              <li class="requirement-item" data-req="length"><i class="fa fa-circle"></i> 8 caracteres o más</li>
              <li class="requirement-item" data-req="upper"><i class="fa fa-circle"></i> 1 letra mayúscula</li>
              <li class="requirement-item" data-req="lower"><i class="fa fa-circle"></i> 1 letra minúscula</li>
              <li class="requirement-item" data-req="number"><i class="fa fa-circle"></i> 1 número</li>
              <li class="requirement-item" data-req="symbol"><i class="fa fa-circle"></i> 1 símbolo (!@#)</li>
            </ul>
            {% for error in form.new_password1.errors %}
              <div class="text-error">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="form-field">
            <label for="{{ form.new_password2.id_for_label }}"><i class="fa fa-lock"></i> Confirmar contraseña</label>
            <div class="input-icon">
              <i class="fa fa-lock"></i>
              <input
                id="{{ form.new_password2.id_for_label }}"
                name="{{ form.new_password2.html_name }}"
                type="password"
                class="form-input"
                autocomplete="new-password"
                placeholder="Repite la contraseña"
                required>
              <span class="toggle-visibility" data-target="{{ form.new_password2.id_for_label }}"><i class="fa fa-eye"></i></span>
            </div>
            {% for error in form.new_password2.errors %}
              <div class="text-error">{{ error }}</div>
            {% endfor %}
          </div>

          <button type="submit" class="auth-cta">Guardar nueva contraseña</button>
        </form>
      </div>
    {% else %}
      <div class="auth-card__header">
        <span class="pill"><i class="fa fa-triangle-exclamation"></i> Enlace inválido</span>
        <h1>El enlace ha expirado</h1>
        <p>Solicita un nuevo correo para restablecer tu contraseña.</p>
      </div>
      <a class="auth-cta" href="{% url 'password_reset' %}"><i class="fa fa-paper-plane"></i> Pedir otro enlace</a>
    {% endif %}
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const year = document.getElementById('year');
      if (year) year.textContent = new Date().getFullYear();

      document.querySelectorAll('.toggle-visibility').forEach(btn => {
        const targetId = btn.dataset.target;
        const input = document.getElementById(targetId);
        if (!input) return;
        btn.addEventListener('click', () => {
          const reveal = input.type === 'password';
          input.type = reveal ? 'text' : 'password';
          btn.innerHTML = `<i class="fa ${reveal ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
        });
      });

      const pwd = document.getElementById('{{ form.new_password1.id_for_label }}');
      const requirements = document.getElementById('resetRequirements');
      if (pwd && requirements) {
        const rules = {
          length: v => v.length >= 8,
          upper: v => /[A-ZÁÉÍÓÚÑ]/.test(v),
          lower: v => /[a-záéíóúñ]/.test(v),
          number: v => /\d/.test(v),
          symbol: v => /[^A-Za-z0-9]/.test(v),
        };
        const update = value => {
          Object.entries(rules).forEach(([key, fn]) => {
            const item = requirements.querySelector(`[data-req="${key}"]`);
            if (!item) return;
            const met = fn(value);
            item.classList.toggle('requirement--met', met);
            const icon = item.querySelector('i');
            if (icon) icon.className = met ? 'fa fa-check-circle' : 'fa fa-circle';
          });
        };
        update(pwd.value || '');
        pwd.addEventListener('input', () => update(pwd.value || ''));
      }
    });
  </script>
{% endblock %}
