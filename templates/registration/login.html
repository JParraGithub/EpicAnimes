{% extends "registration/auth_base.html" %}
{% load static %}
{% block title %}Iniciar sesión | EpicAnimes{% endblock %}
  {# Renderiza el formulario de inicio de sesión con verificación OTP.  #}

{% block auth_content %}
  <section class="auth-grid">
    <div class="auth-card glass">
      <div class="auth-card__header">
        <span class="pill"><i class="fa fa-shield-halved"></i> Acceso seguro</span>
        <h1>Bienvenido de vuelta</h1>
        <p>Retoma tus compras, chats y favoritos justo donde los dejaste.</p>
      </div>

      {% if form.non_field_errors %}
        <div class="message message--warning">
          <i class="fa fa-circle-exclamation"></i>
          <span>
            {% for error in form.non_field_errors %}
              {{ error }}{% if not forloop.last %}<br>{% endif %}
            {% endfor %}
          </span>
        </div>
      {% endif %}

      <div class="auth-form-panel">
        <form method="post" class="auth-form" novalidate>
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ next|default:'/accounts/profile/' }}">

          <div class="form-field">
            <label for="id_username"><i class="fa fa-user"></i> Usuario</label>
            <div class="input-icon">
              <i class="fa fa-user"></i>
              <input id="id_username" name="username" type="text" class="form-input" placeholder="Tu usuario" value="{{ form.username.value|default:'' }}" required autofocus>
            </div>
            {% if form.username.errors %}
              <div class="text-error">{{ form.username.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="form-field">
            <label for="id_password"><i class="fa fa-lock"></i> Contraseña</label>
            <div class="input-icon">
              <i class="fa fa-key"></i>
              <input id="id_password" name="password" type="password" class="form-input" placeholder="Tu contraseña" required autocomplete="current-password">
              <button class="toggle-visibility" type="button" data-target="id_password" aria-label="Mostrar u ocultar contraseña">
                <i class="fa fa-eye"></i>
              </button>
            </div>
            {% if form.password.errors %}
              <div class="text-error">{{ form.password.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="form-field">
            <label for="id_otp"><i class="fa fa-shield"></i> Código de verificación</label>
            <div class="input-icon">
              <i class="fa fa-shield-halved"></i>
              <input id="id_otp" name="otp" type="text" class="form-input" placeholder="Ingresa el código de 6 dígitos" inputmode="numeric" pattern="\d{6}">
            </div>
            <div class="otp-actions">
              <button type="button" class="auth-secondary-btn" id="btnSendOtp">
                <i class="fa fa-paper-plane"></i> Enviar código
              </button>
              <small class="auth-status" id="otpStatus">Lo recibirás por correo.</small>
            </div>
          </div>

          <button type="submit" class="auth-cta">
            <i class="fa fa-right-to-bracket"></i> Iniciar sesión
          </button>

          <div class="auth-links">
            <span>¿Nuevo en EpicAnimes?<a href="{% url 'signup' %}"> ¡Crea una cuenta!</a></span>
            <a href="{% url 'password_reset' %}"><br><i class="fa fa-unlock"></i> ¿Olvidaste tu contraseña?</a>
            
          </div>
        </form>
      </div>
    </div>

    <aside class="auth-side glass">
      <h2><i class="fa fa-wand-magic-sparkles"></i> Beneficios inmediatos</h2>
      <ul class="auth-steps">
        <li class="auth-step">
          <i class="fa fa-bolt"></i>
          <div>
            <span>Pagos listos</span>
            <p>El carrito mantiene tus pedidos y presenta el botón de PayPal sin salir del flujo.</p>
          </div>
        </li>
        <li class="auth-step">
          <i class="fa fa-robot"></i>
          <div>
            <span>Chatbot mejorado</span>
            <p>Responde más natural, permite minimizar el popup y combina con el índice.</p>
          </div>
        </li>
        <li class="auth-step">
          <i class="fa fa-user-shield"></i>
          <div>
            <span>Doble verificación</span>
            <p>Protegemos tu cuenta con OTP cada vez que detectamos actividad nueva.</p>
          </div>
        </li>
      </ul>
      <div class="auth-tip">
        <i class="fa fa-circle-info"></i>
        <p>Si no ves el correo del código, revisa spam o solicita uno nuevo en unos segundos.</p>
      </div>
    </aside>
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const year = document.getElementById('year');
      if (year) year.textContent = new Date().getFullYear();

      document.querySelectorAll('.toggle-visibility').forEach(btn => {
        btn.addEventListener('click', () => {
          const input = document.getElementById(btn.dataset.target);
          if (!input) return;
          const reveal = input.type === 'password';
          input.type = reveal ? 'text' : 'password';
          btn.innerHTML = `<i class="fa ${reveal ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
        });
      });

      const btnSendOtp = document.getElementById('btnSendOtp');
      const otpStatus = document.getElementById('otpStatus');
      const usernameInput = document.getElementById('id_username');
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

      if (btnSendOtp && usernameInput) {
        btnSendOtp.addEventListener('click', async () => {
          const username = (usernameInput.value || '').trim();
          if (!username) {
            if (otpStatus) otpStatus.textContent = 'Ingresa tu usuario antes de solicitar el código.';
            return;
          }

          btnSendOtp.disabled = true;
          if (otpStatus) otpStatus.textContent = 'Enviando código...';

          try {
            const response = await fetch('/accounts/send-otp/', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              body: 'username=' + encodeURIComponent(username)
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) throw new Error(data.error || 'No se pudo enviar el código.');
            if (otpStatus) otpStatus.textContent = 'Código enviado. Revisa tu bandeja de entrada.';
          } catch (error) {
            if (otpStatus) otpStatus.textContent = error.message || 'Error al enviar el código.';
          } finally {
            btnSendOtp.disabled = false;
          }
        });
      }
    });
  </script>
{% endblock %}
