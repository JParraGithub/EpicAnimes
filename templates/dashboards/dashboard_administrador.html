{% load static %}
<!DOCTYPE html>
<!-- Conforma el cascarón HTML del panel administrativo. -->
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EpicAnimes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/dashboards/dashboard_administrador.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="theme-cool">
  <div class="dashboard-container">
    <aside class="sidebar">
      <a class="logo" href="{% url 'index' %}"><i class="fas fa-hat-wizard"></i> <span class="logo-brand">EpicAnimes</span></a>
      <nav>
        <a class="active" data-section="bienvenido"><i class="fas fa-handshake"></i> Bienvenido, {{ request.user.username }}</a>
        <a data-section="vendedores"><i class="fas fa-user-tie"></i> Gestión Vendedores</a>
        <a data-section="usuarios_gestion"><i class="fas fa-users-cog"></i> Gestión Usuarios</a>
        <a data-section="stock"><i class="fas fa-warehouse"></i> Gestión de Stock</a>
        <a data-section="graficos"><i class="fas fa-chart-line"></i> Gráficos de Ventas</a>
        <a data-section="postulaciones"><i class="fas fa-user-plus"></i> Postulaciones</a>
        <a href="{% url 'index' %}"><i class="fas fa-sign-out-alt"></i> Salir</a>
      </nav>
    </aside>

    <main class="content">
      <h1>Panel de Administración</h1>

      <!-- Gestión Vendedores -->
      <!-- Bienvenida Admin -->
      <section id="bienvenido" class="section-group active">
        <h2 class="section-title"><i class="fas fa-user-shield"></i> Hola, {{ request.user.username }}</h2>
        <div class="kpi-grid">
          <div class="kpi-card">
            <i class="fas fa-user icon-large"></i>
            <div class="data">
              <p class="title">Usuario</p>
              <span class="value">{{ request.user.username }}</span>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-envelope icon-large"></i>
            <div class="data">
              <p class="title">Email</p>
              <span class="value">{{ request.user.email|default:'-' }}</span>
            </div>
          </div>
        </div>
        <br>
        <div class="chart-card">
          <h3 class="card-title">Accesos rápidos</h3>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'vendedores\']').click(); return false;"><i class="fas fa-user-tie"></i> Vendedores</a>
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'usuarios_gestion\']').click(); return false;"><i class="fas fa-users-cog"></i> Usuarios</a>
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'stock\']').click(); return false;"><i class="fas fa-warehouse"></i> Stock</a>
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'graficos\']').click(); return false;"><i class="fas fa-chart-line"></i> Gráfico de Ventas</a>
            <a class="btn" href="#" onclick="document.querySelector('.sidebar nav a[data-section=\'postulaciones\']').click(); return false;"><i class="fas fa-user-plus"></i> Postulaciones</a>
            <a class="btn" href="{% url 'index' %}"><i class="fas fa-sign-out-alt"></i> Salir</a>
          </div>
        </div>
        <br>
        <div class="charts-wrapper">
          <div class="chart-box large" id="estadoGlobalBox">
            <div class="table-tools" style="margin-bottom:8px;">
              <div class="left">
                <label for="selectEstadoGlobalRange" style="color:#cfe6ff; font-size:14px; margin-right:8px;">Rango:</label>
                <div class="chip-group" data-select="#selectEstadoGlobalRange" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
                  <a href="#" class="btn ghost" data-value="30">30 días</a>
                  <a href="#" class="btn ghost" data-value="90">90 días</a>
                  <a href="#" class="btn ghost" data-value="180">180 días</a>
                  <a href="#" class="btn ghost" data-value="365">365 días</a>
                </div>
                <select id="selectEstadoGlobalRange" style="display:none;">
                  <option value="30">Ultimos 30 dias</option>
                  <option value="90">Ultimos 90 dias</option>
                  <option value="180">Ultimos 180 dias</option>
                  <option value="365">Ultimos 365 dias</option>
                </select>
              </div>
              <div class="right chart-filter-group">
                <button type="button" id="toggleEstadoGlobalPresence" class="chart-toggle chart-toggle--compact" data-active="0" aria-pressed="false">
                  <span class="chart-toggle__icon chart-toggle__icon--on"><i class="fas fa-check"></i></span>
                  <span class="chart-toggle__icon chart-toggle__icon--off"><i class="fas fa-times"></i></span>
                  <span class="chart-toggle__label">Sin presencia</span>
                </button>
                <label for="selectEstadoGlobalWindow" class="chart-filter-label">Ventana:</label>
                <div class="chip-group" data-select="#selectEstadoGlobalWindow" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
                  <a href="#" class="btn ghost" data-value="180">180 s</a>
                  <a href="#" class="btn ghost" data-value="300">300 s</a>
                  <a href="#" class="btn ghost" data-value="600">600 s</a>
                  <a href="#" class="btn ghost" data-value="900">900 s</a>
                </div>
                <select id="selectEstadoGlobalWindow" class="chart-filter-select" style="height: 4vh; display:none;" disabled>
                  <option value="180">180 s</option>
                  <option value="300">300 s</option>
                  <option value="600">600 s</option>
                  <option value="900">900 s</option>
                </select>
              </div>
            </div>
            <div class="ventas-usuarios-layout">
              <div class="ventas-usuarios-chart">
                <canvas id="chartEstadoGlobal"></canvas>
                <p id="estadoGlobalPlaceholder" class="chart-placeholder">Sin datos.</p>
              </div>
              <div id="estadoGlobalStats" class="chart-side-cards" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Gestión Vendedores -->
      <section id="vendedores" class="section-group">
        <h2><i class="fas fa-user-tie"></i> Gestión de Vendedores</h2>
        <div class="table-tools">
          <div class="left">
            <input type="text" id="vend_buscar" placeholder="Buscar por nombre o email...">
            <select id="vend_estado">
              <option value="todos" style="color: #F54865">Todos</option>
              <option value="activo" style="color: #F54865">Activos</option>
              <option value="inactivo" style="color: #F54865">Inactivos</option>
              <option value="suspendido" style="color: #F54865">Suspendidos</option>
            </select>
          </div>
          <div class="right">
            <button class="btn" id="vend_btnAgregar">+ Agregar vendedor</button>
          </div>
        </div>
        <table class="data-table" id="tablaVendedores">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Fecha creación</th>
              <th>Contraseña</th>
              <th>Estado</th>
              <th>Cambiar Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <br>

        <!-- Graficos de Vendedores  -->
        <div class="charts-wrapper vendor-charts">
          <div class="chart-box small vendor-estado-box" id="vendorEstadoChartBox">
            <div class="chart-box__header">
              <h3 class="chart-title">Activos / Inactivos / Suspendidos</h3>
              <span class="chart-subtitle" id="vendorEstadoSummary"></span>
            </div>
            <div class="chart-box__canvas">
              <canvas id="chartVendEstado"></canvas>
              <p class="chart-placeholder" id="vendorEstadoPlaceholder">Sin datos para mostrar.</p>
            </div>
            <div class="vendor-estado-legend" id="vendorEstadoLegend"></div>
          </div>
          <div class="chart-box small vendor-top-chart" id="vendorTopChartBox" style="display:none;">
            <h3 class="chart-title">Top 3 productos de <span id="vendorTopName"></span></h3>
            <div class="chart-box__canvas chart-box__canvas--bars">
              <canvas id="chartVendTopProductos"></canvas>
              <p class="chart-placeholder" id="vendorTopPlaceholder">Busca un vendedor para ver sus productos destacados.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Gestión Usuarios -->
      <section id="usuarios_gestion" class="section-group">
        <h2><i class="fas fa-users-cog"></i> Gestión de Usuarios</h2>
        <div class="table-tools">
          <div class="left">
            <input type="text" id="usr_buscar" placeholder="Buscar por usuario o email...">
            <select id="usr_estado">
              <option value="todos" style="color: #F54865">Todos</option>
              <option value="activo" style="color: #F54865">Activos</option>
              <option value="inactivo" style="color: #F54865">Inactivos</option>
              <option value="suspendido" style="color: #F54865">Suspendidos</option>
            </select>
          </div>
        </div>
        <table class="data-table" id="tablaUsuarios">
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Cambiar Estado</th>
              <th>Último acceso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <br>

        <!-- Graficos de Usuarios -->
        <div class="charts-wrapper user-charts">
          <div class="chart-box small user-estado-box" id="userEstadoChartBox">
            <div class="chart-box__header">
              <h3 class="chart-title">Activos / Inactivos / Suspendidos</h3>
              <span class="chart-subtitle" id="userEstadoSummary"></span>
            </div>
            <div class="chart-box__canvas">
              <canvas id="chartUserEstado"></canvas>
              <p class="chart-placeholder" id="userEstadoPlaceholder">Sin datos para mostrar.</p>
            </div>
            <div class="user-estado-legend" id="userEstadoLegend"></div>
          </div>
          <div class="chart-box small user-top-chart" id="userTopChartBox" style="display:none;">
            <h3 class="chart-title">Top 3 productos de <span id="userTopName"></span></h3>
            <div class="chart-box__canvas chart-box__canvas--bars">
              <canvas id="chartUserTopProductos"></canvas>
              <p class="chart-placeholder" id="userTopPlaceholder">Busca un usuario para ver sus productos destacados.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Gestión Stock -->
      <section id="stock" class="section-group">
        <h2><i class="fas fa-warehouse"></i> Control de Stock por Vendedor</h2>
        <p class="hint">Filtra por nombre de vendedor para ver y editar su stock.</p>
        <div class="stock-card">
          <div class="stock-toolbar">
            <input type="text" id="stock_buscar" placeholder="Buscar vendedor..." class="select-control" style="max-width:220px">
            <select id="stock_vendedor" class="select-control"></select>
            <button class="btn" id="stock_btnRecargar">Actualizar</button>
          </div>
          <div class="table-wrapper">
            <table class="data-table" id="tablaStock">  
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Vendedor</th>
                  <th>Nombre</th>
                  <th>Tipo</th>
                  <th>Imagen</th>
                  <th>Descripción</th>
                  <th>Stock</th>
                  <th>Crítico</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="stock-card stock-edit-card">
          <div class="stock-edit-header">
            <h3><i class="fas fa-pen-alt"></i> Editar Productos</h3>
            <p id="stockEditStatus" class="stock-edit-status">Selecciona un producto de la tabla para editarlo.</p>
          </div>
          <form id="formEditarProductoAdmin" enctype="multipart/form-data" class="stock-edit-form">
            <div class="stock-edit-grid">
              <label>
                <span>ID</span>
                <input type="text" id="a_id" name="id" readonly>
              </label>
              <label>
                <span>Vendedor</span>
                <input type="text" id="a_vendedor" readonly>
              </label>
              <label>
                <span>Nombre producto</span>
                <input type="text" id="a_nombre" name="nombre" placeholder="Nombre">
              </label>
              <label>
                <span>Tipo producto</span>
                <input type="text" id="a_categoria" name="categoria" placeholder="Tipo o categoría">
              </label>
              <label class="full">
                <span>Descripción</span>
                <textarea id="a_descripcion" name="descripcion" rows="2" placeholder="Descripción"></textarea>
              </label>
              <label>
                <span>Stock</span>
                <input type="number" id="a_existencias" name="existencias" min="0" placeholder="0">
              </label>
              <label class="full">
                <span>Imagen</span>
                <input type="file" id="a_imagen" name="imagen" accept="image/*">
                <img id="a_imagen_preview"
                     alt="Preview"
                     style="display:none"
                     width="180"
                     height="180"
                     loading="lazy"
                     decoding="async">
              </label>
            </div>
            <div class="stock-edit-actions">
              <button type="button" class="btn ghost" id="btnAccCancelar">Cancelar</button>
              <button type="button" class="btn danger" id="btnAccEliminar">Eliminar</button>
              <button type="submit" class="btn success" id="btnAccGuardar">Guardar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Gráficos -->

      <!-- GRÁFICO DE LINEAS-->
      <section id="graficos" class="section-group">
        <br>
        <div class="graficos-subsection">
          <h2><i class="fas fa-chart-line"></i> Gráficos de ventas y actividad</h2>
          <div class="charts-wrapper">
            <div class="chart-box large" id="ventasActividadBox">
              <div class="table-tools" style="margin-bottom:8px;">
                <div class="left">
                  <label for="ventasActividadRange" style="color:#cfe6ff; font-size:14px; margin-right:8px;">Rango:</label>
                  <div class="chip-group" data-select="#ventasActividadRange" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
                    <a href="#" class="btn ghost" data-value="30">30 días</a>
                    <a href="#" class="btn ghost" data-value="90">90 días</a>
                    <a href="#" class="btn ghost" data-value="180">180 días</a>
                  </div>
                  <select id="ventasActividadRange" style="display:none;">
                    <option value="30">Ultimos 30 dias</option>
                    <option value="90">Ultimos 90 dias</option>
                    <option value="180">Ultimos 180 dias</option>
                  </select>
                </div>
              </div>
              <div class="chart-toggle-group" id="ventasActividadToggles">
                <button type="button" class="chart-toggle" data-series="ventas" aria-pressed="true">
                  <span class="chart-toggle__icon chart-toggle__icon--on"><i class="fas fa-check"></i></span>
                  <span class="chart-toggle__icon chart-toggle__icon--off"><i class="fas fa-times"></i></span>
                  <span class="chart-toggle__label">Total vendido</span>
                </button>
                <button type="button" class="chart-toggle" data-series="ordenes" aria-pressed="true">
                  <span class="chart-toggle__icon chart-toggle__icon--on"><i class="fas fa-check"></i></span>
                  <span class="chart-toggle__icon chart-toggle__icon--off"><i class="fas fa-times"></i></span>
                  <span class="chart-toggle__label">Ordenes</span>
                </button>
                <button type="button" class="chart-toggle" data-series="vendedores" aria-pressed="true">
                  <span class="chart-toggle__icon chart-toggle__icon--on"><i class="fas fa-check"></i></span>
                  <span class="chart-toggle__icon chart-toggle__icon--off"><i class="fas fa-times"></i></span>
                  <span class="chart-toggle__label">Vendedores</span>
                </button>
              </div>
              <div style="position:relative; min-height:320px;">
                <div
                  id="ventasActividadPlaceholder"
                  style="
                    display:none;
                    position:absolute;
                    right:16px;
                    top:16px;
                    padding:4px 12px;
                    border-radius:999px;
                    background:rgba(11, 17, 32, 0.9);
                    color:#c9dbf5;
                    font-size:11px;
                    letter-spacing:0.02em;
                    text-transform:uppercase;
                    max-width:260px;
                    text-align:right;
                    pointer-events:none;
                    box-shadow:0 6px 12px rgba(0,0,0,0.25);
                  "
                >
                  Sin datos disponibles en el periodo seleccionado.
                </div>
                <canvas id="chartVentasActividad"></canvas>
              </div>
            </div>
          </div>
        </div>
      <!-- continúa sección graficos -->

      <br>
      
      <!-- GRáFICO DE BARRAS (misma sección) -->
      <div class="graficos-subsection">
        <br>
        <h2><i class="fas fa-chart-bar"></i> Gráficos de Ventas por Usuario</h2>
        <div class="charts-wrapper">
          <div class="chart-box large" id="ventasPorUsuarioBox">
            <div class="ventas-usuarios-filters">
              <div class="ventas-usuarios-filter-block">
                <div class="ventas-usuarios-filter-row">
                  <label for="selectVentasUsuariosRangeInner" class="chart-filter-label">Rango:</label>
                  <div class="chip-group" data-select="#selectVentasUsuariosRangeInner">
                    <a href="#" class="btn ghost" data-value="30">30 días</a>
                    <a href="#" class="btn ghost" data-value="90">90 días</a>
                    <a href="#" class="btn ghost" data-value="180">180 días</a>
                    <a href="#" class="btn ghost" data-value="365">365 días</a>
                  </div>
                  <select id="selectVentasUsuariosRangeInner" style="display:none;">
                    <option value="30">Ultimos 30 dias</option>
                    <option value="90">Ultimos 90 dias</option>
                    <option value="180">Ultimos 180 dias</option>
                    <option value="365">Ultimos 365 dias</option>
                  </select>
                </div>
                <div class="ventas-usuarios-filter-row">
                  <label for="selectVentasUsuariosTop" class="chart-filter-label">Top:</label>
                  <div class="chip-group" data-select="#selectVentasUsuariosTop">
                    <a href="#" class="btn ghost" data-value="5">5</a>
                    <a href="#" class="btn ghost" data-value="10">10</a>
                    <a href="#" class="btn ghost" data-value="15">15</a>
                    <a href="#" class="btn ghost" data-value="25">25</a>
                    <a href="#" class="btn ghost" data-value="50">50</a>
                  </div>
                  <select id="selectVentasUsuariosTop" class="chart-filter-select" style="display:none;">
                    <option value="5">Top 5</option>
                    <option value="10" selected>Top 10</option>
                    <option value="15">Top 15</option>
                    <option value="25">Top 25</option>
                    <option value="50">Top 50</option>
                  </select>
                </div>
              </div>
              <div class="ventas-usuarios-filter-block ventas-usuarios-filter-block--compact">
                <div class="ventas-usuarios-filter-row presence-row">
                  <button type="button" id="toggleVentasUsuariosPresence" class="chart-toggle chart-toggle--compact" data-active="0" aria-pressed="false">
                    <span class="chart-toggle__icon chart-toggle__icon--on"><i class="fas fa-check"></i></span>
                    <span class="chart-toggle__icon chart-toggle__icon--off"><i class="fas fa-times"></i></span>
                    <span class="chart-toggle__label">Sin presencia</span>
                  </button>
                </div>
                <div class="ventas-usuarios-filter-row">
                  <label for="selectVentasUsuariosWindow" class="chart-filter-label">Ventana:</label>
                  <div class="chip-group" data-select="#selectVentasUsuariosWindow">
                    <a href="#" class="btn ghost" data-value="180">180 s</a>
                    <a href="#" class="btn ghost" data-value="300">300 s</a>
                    <a href="#" class="btn ghost" data-value="600">600 s</a>
                    <a href="#" class="btn ghost" data-value="900">900 s</a>
                  </div>
                  <select id="selectVentasUsuariosWindow" class="chart-filter-select" disabled style="display:none;">
                    <option value="180">180 s</option>
                    <option value="300">300 s</option>
                    <option value="600">600 s</option>
                    <option value="900">900 s</option>
                  </select>
                </div>
              </div>
            </div>
            <div id="ventasPorUsuarioLayout" class="ventas-usuarios-layout">
              <div class="ventas-usuarios-chart">
                <canvas id="chartVentasUsuarios"></canvas>
              </div>
              <div id="ventasPorUsuarioStats" class="chart-side-cards" aria-live="polite"></div>
            </div>
      </div>
        </div>
      </section>
      <br>


      

      <!-- Postulaciones -->
      <section id="postulaciones" class="section-group">
        <h2><i class="fas fa-user-plus"></i> Postulaciones de vendedores</h2>
        <div class="table-tools">
          <div class="left">
            <input type="text" id="post_buscar" placeholder="Buscar por nombre o email...">
            <select id="post_estado">
              <option value="todos" style="color: #F54865">Todos</option>
              <option value="nuevo" style="color: #F54865">Nuevos</option>
              <option value="contactado" style="color: #F54865">Contactados</option>
              <option value="archivado" style="color: #F54865">Archivados</option>
            </select>
          </div>
          <div class="right">
            <a class="btn primary" id="exportPostExcel" href="#">Exportar Excel</a>
            <a class="btn primary" id="exportVentasExcel" href="#">Ventas 30 días (Excel)</a>
          </div>
        </div>
        <table class="data-table" id="tablaPostulaciones">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Tienda</th>
              <th>Instagram / Web</th>
              <th>Mensaje</th>
              <th>Notas</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Modal editar -->
  <div class="modal" id="modalEditar" hidden>
    <div class="card">
      <h3>Editar Usuario</h3>
      <label>Nombre</label><input id="editNombre" type="text">
      <label>Email</label><input id="editEmail" type="email">
      <label>Contraseña (vacía para no cambiar)</label><input id="editPass" type="password">
                  <div class="actions">
        <button class="btn" id="guardarEditar">Guardar</button>
        <button class="btn danger" id="eliminarUsuario">Eliminar</button>
        <button class="btn ghost" id="cancelarEditar">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal agregar -->
  <div class="modal" id="modalAgregar" hidden>
    <div class="card">
      <h3 id="modalAgregarTitle">Agregar vendedor</h3>
      <label for="newNombre">Nombre de usuario</label>
      <input id="newNombre" type="text" placeholder="usuario_epic">
      <label for="newEmail">Email</label>
      <input id="newEmail" type="email" placeholder="correo@dominio.com">
      <label for="newPass">Contraseña</label>
      <input id="newPass" type="password" placeholder="********">
      <div class="password-requirements" id="vendPasswordRequirements">
        <p>Tu contraseña debe incluir:</p>
        <ul>
          <li data-req="length"><i class="fa fa-circle"></i> 8 caracteres o más</li>
          <li data-req="upper"><i class="fa fa-circle"></i> 1 letra mayúscula</li>
          <li data-req="lower"><i class="fa fa-circle"></i> 1 letra minúscula</li>
          <li data-req="number"><i class="fa fa-circle"></i> 1 número</li>
          <li data-req="symbol"><i class="fa fa-circle"></i> 1 símbolo (!@#$%^&*)</li>
        </ul>
      </div>
      <label for="newPass2">Confirmar contraseña</label>
      <input id="newPass2" type="password" placeholder="********">
      <div class="match-indicator" id="vendPasswordMatch"></div>
      <p class="form-error" id="modalAgregarError" aria-live="polite"></p>
      <div class="actions">
        <button class="btn primary" id="guardarNuevo" type="button">Guardar</button>
        <button class="btn ghost" id="cancelarNuevo" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <form style="display:none">{% csrf_token %}</form>
  <script src="{% static 'js/dashboards/admin/dashboard_administrador.js' %}"></script>
  <script src="{% static 'js/dashboards/admin/dashboard_administrador_charts.js' %}"></script>
  <script src="{% static 'js/dashboards/admin/dashboard_estado_global.js' %}"></script>
  <script src="{% static 'js/dashboards/admin/dashboard_ventas_usuarios_cards.js' %}"></script>
  <script src="{% static 'js/dashboards/admin/dashboard_vendedores_estado.js' %}"></script>
  <script src="{% static 'js/dashboards/admin/ventas_usuarios_barras.js' %}"></script>
  
  <script>
  (function(){
    // Chips -> Select sync (oculta selects, usa enlaces)
    function initChipGroup(group){
      const selId = group.getAttribute('data-select');
      const select = selId ? document.querySelector(selId) : null;
      if (!select) return;
      const anchors = Array.from(group.querySelectorAll('a[data-value]'));
      const setActive = (value) => {
        anchors.forEach(a => {
          const active = (a.getAttribute('data-value') === String(value));
          a.classList.toggle('success', active);
          a.classList.toggle('ghost', !active);
        });
      };
      anchors.forEach(a => a.addEventListener('click', (ev) => {
        ev.preventDefault();
        const val = a.getAttribute('data-value');
        if (!val) return;
        select.value = val;
        try { select.dispatchEvent(new Event('change', { bubbles:true })); } catch(_){ select.dispatchEvent(document.createEvent('Event')).initEvent('change', true, true); }
        setActive(val);
      }));
      // Estado inicial
      setActive(select.value || anchors[0]?.getAttribute('data-value'));
    }
    document.querySelectorAll('.chip-group[data-select]').forEach(initChipGroup);
    // Fix quick links (Bienvenido) navigation targets and keep accents
    const quickBox = document.querySelector('#bienvenido .chart-card div');
    if (quickBox) {
      const links = quickBox.querySelectorAll('a.btn');
      const map = ['vendedores','usuarios_gestion','stock','graficos','postulaciones', null];
      links.forEach((a, i) => {
        // neutraliza cualquier onclick embebido problemático
        a.onclick = null;
        if (i === 3) { a.innerHTML = '<i class="fas fa-chart-line"></i> Gráfico de Ventas'; }
        if (i === 5) { return; }
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const key = map[i];
          if (!key) { window.location.href = a.getAttribute('href') || '/'; return; }
          const target = document.querySelector(`.sidebar nav a[data-section='${key}']`);
          if (target) target.click();
        });
      });
      const quickTitle = document.querySelector('#bienvenido .chart-card .card-title');
      if (quickTitle) quickTitle.textContent = 'Accesos rápidos';
    }

    // Normalize accented labels/headers shown in this template
    try {
      const h1 = document.querySelector('main.content h1');
      if (h1) h1.textContent = 'Panel de Administración';
      const aVend = document.querySelector('.sidebar nav a[data-section="vendedores"]');
      if (aVend) aVend.innerHTML = '<i class="fas fa-user-tie"></i> Gestión Vendedores';
      const aUsr = document.querySelector('.sidebar nav a[data-section="usuarios_gestion"]');
      if (aUsr) aUsr.innerHTML = '<i class="fas fa-users-cog"></i> Gestión Usuarios';
      const aStock = document.querySelector('.sidebar nav a[data-section="stock"]');
      if (aStock) aStock.innerHTML = '<i class="fas fa-warehouse"></i> Gestión de Stock';
      const aGraf = document.querySelector('.sidebar nav a[data-section="graficos"]');
      if (aGraf) aGraf.innerHTML = '<i class="fas fa-chart-line"></i> Gráficos de Ventas';

      const vendTitle = document.querySelector('#vendedores h2');
      if (vendTitle) vendTitle.innerHTML = '<i class="fas fa-user-tie"></i> Gestión de Vendedores';
      const vendTh = document.querySelectorAll('#tablaVendedores thead th');
      if (vendTh && vendTh.length >= 6) {
        if (vendTh[3]) vendTh[3].textContent = 'Fecha creación';
        if (vendTh[4]) vendTh[4].textContent = 'Contraseña';
      }

      const usrTitle = document.querySelector('#usuarios_gestion h2');
      if (usrTitle) usrTitle.innerHTML = '<i class="fas fa-users-cog"></i> Gestión de Usuarios';
      const usrTh = document.querySelectorAll('#tablaUsuarios thead th');
      if (usrTh && usrTh.length >= 7) { if (usrTh[5]) usrTh[5].textContent = 'Cambiar Estado'; if (usrTh[6]) usrTh[6].textContent = 'último acceso'; }

      const stockTh = document.querySelectorAll('#stock #tablaStock thead th');
      if (stockTh && stockTh.length >= 8) {
        if (stockTh[5]) stockTh[5].textContent = 'Descripción';
        if (stockTh[7]) stockTh[7].textContent = 'Crítico';
      }

      const grafTitle = document.querySelector('#graficos h2');
      if (grafTitle) grafTitle.innerHTML = '<i class="fas fa-chart-line"></i> Gráficos de ventas y actividad';

      const btnVentas = document.getElementById('exportVentasExcel');
      if (btnVentas) btnVentas.textContent = 'Ventas 30 días (Excel)';
      const postTh = document.querySelectorAll('#tablaPostulaciones thead th');
      if (postTh && postTh.length >= 4) {
        if (postTh[3]) postTh[3].textContent = 'Teléfono';
      }

      const lblEditPass = document.querySelector('#editPass')?.previousElementSibling;
      if (lblEditPass && lblEditPass.tagName === 'LABEL') lblEditPass.textContent = 'Contraseña (vacía para no cambiar)';
      const lblPass2 = document.querySelector('#editPass2')?.previousElementSibling;
      if (lblPass2 && lblPass2.tagName === 'LABEL') lblPass2.textContent = 'Confirmar contraseña';
      const lblNewPass2 = document.querySelector('#newPass2')?.previousElementSibling;
      if (lblNewPass2 && lblNewPass2.tagName === 'LABEL') lblNewPass2.textContent = 'Confirmar contraseña';
      const lblNewPass = document.querySelector('#newPass')?.previousElementSibling;
      if (lblNewPass && lblNewPass.tagName === 'LABEL') lblNewPass.textContent = 'Contraseña';
    } catch (_) {}

    // Vendedores: agregar columna "Cambiar Estado" como badge clickeable con mismo CSS que "Estado"
    const vendBody = document.querySelector('#tablaVendedores tbody');
    if (!vendBody) return;

    const getCookie = (name) => {
      const value = '; ' + document.cookie;
      const parts = value.split('; ' + name + '=');
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      return null;
    };
    const csrftoken = getCookie('csrftoken');

    const addToggleCell = (tr) => {
      const tds = tr.querySelectorAll('td');
      if (tds.length !== 7) return; // insertar solo cuando falta la columna
      const disabled = tr.getAttribute('data-disabled') === '1';
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'status-badge ' + (disabled ? 'offline' : 'online');
      btn.dataset.action = 'toggle';
      btn.textContent = disabled ? 'Inactivo' : 'Activo';
      td.appendChild(btn);
      tr.insertBefore(td, tds[tds.length - 1]); // antes de Acciones
    };

    // Inicializa filas existentes
    vendBody.querySelectorAll('tr[data-id]').forEach(addToggleCell);

    const mo = new MutationObserver((mutations) => {
      mutations.forEach((m) => {
        m.addedNodes.forEach((node) => {
          if (node.nodeType === 1 && node.matches('tr[data-id]')) {
            addToggleCell(node);
          }
        });
      });
    });
    mo.observe(vendBody, { childList: true });

    vendBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button[data-action="toggle"]');
      if (!btn) return;
      const tr = btn.closest('tr[data-id]');
      const id = Number(tr?.dataset?.id || '');
      if (!id) return;
      const currentlyDisabled = tr.getAttribute('data-disabled') === '1';
      const newActive = currentlyDisabled; // si estaba inactivo, activar; si activo, desactivar
      try {
        const resp = await fetch('/api/admin/vendedores/', {
          method: 'PUT',
          headers: Object.assign({ 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, csrftoken ? { 'X-CSRFToken': csrftoken } : {}),
          credentials: 'same-origin',
          body: JSON.stringify({ id, is_active: newActive })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        // Actualiza dataset
        tr.setAttribute('data-disabled', newActive ? '0' : '1');
        const disabledNow = !newActive;
        // Actualiza badge de Estado (6ta columna)
        const estadoBadge = tr.querySelector('td:nth-child(6) .status-badge');
        if (estadoBadge) {
          estadoBadge.textContent = disabledNow ? 'Suspendido' : 'Activo';
          estadoBadge.classList.toggle('online', !disabledNow);
          estadoBadge.classList.toggle('offline', disabledNow);
          estadoBadge.classList.toggle('suspended', disabledNow);
        }
        // Actualiza badge de cambio (esta celda)
        btn.textContent = disabledNow ? 'Inactivo' : 'Activo';
        btn.classList.toggle('online', !disabledNow);
        btn.classList.toggle('offline', disabledNow);
        // Recalcula filtro y gráfico en tiempo real
        setTimeout(() => { applyVendorFilter(); updateVendorEstadoChart(); }, 30);
      } catch (e) {
        console.error('No se pudo cambiar el estado', e);
        alert('No se pudo cambiar el estado.');
      }
    });

    // ===== Filtro Activos / Inactivos / Suspendidos y gráfico en tiempo real =====
    const vendEstadoSel = document.getElementById('vend_estado');
    const vendBuscarInp = document.getElementById('vend_buscar');

    const rowState = (tr) => {
      const badge = tr.querySelector('td:nth-child(6) .status-badge');
      if (!badge) return 'inactivo';
      const txt = (badge.textContent || '').trim().toLowerCase();
      if (txt.startsWith('suspend')) return 'suspendido';
      if (txt.startsWith('activo')) return 'activo';
      return 'inactivo';
    };

    const applyVendorFilter = () => {
      const val = (vendEstadoSel?.value || 'todos').toLowerCase();
      vendBody.querySelectorAll('tr[data-id]').forEach((tr) => {
        const st = rowState(tr);
        const show = (val === 'todos') || (st === val);
        tr.style.display = show ? '' : 'none';
      });
    };

    const computeVendorCounts = () => {
      let activos = 0, inactivos = 0, suspendidos = 0;
      vendBody.querySelectorAll('tr[data-id]').forEach((tr) => {
        if (tr.style.display === 'none') return; // respeta filtro de búsqueda externo
        const st = rowState(tr);
        if (st === 'activo') activos++;
        else if (st === 'suspendido') suspendidos++;
        else inactivos++;
      });
      return { activos, inactivos, suspendidos };
    };

    const updateVendorEstadoChart = () => {
      const canvas = document.getElementById('chartVendEstado');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const existing = (window.Chart && Chart.getChart) ? Chart.getChart(canvas) : (canvas.__chart || null);
      if (existing) existing.destroy();
      const { activos, inactivos, suspendidos } = computeVendorCounts();
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Activos', 'Inactivos', 'Suspendidos'],
          datasets: [{ data: [activos, inactivos, suspendidos], backgroundColor: ['#37d67a', '#ff5a5f', '#ffb347'], borderWidth: 0 }],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#cfe6ff' } } } },
      });
      canvas.__chart = chart;
    };

    // Observers para refrescar al cargar/editar/tiempo real
    let rafId = null;
    const scheduleRefresh = () => {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => { applyVendorFilter(); updateVendorEstadoChart(); });
    };
    new MutationObserver(scheduleRefresh).observe(vendBody, { childList: true, subtree: true, characterData: true });
    vendEstadoSel?.addEventListener('change', () => setTimeout(scheduleRefresh, 50));
    vendBuscarInp?.addEventListener('input', () => setTimeout(scheduleRefresh, 200));
    scheduleRefresh();

    // ===== Postulaciones: filtro por estado (cliente) y export con estado =====
    try {
      const postEstadoSel = document.getElementById('post_estado');
      const postBuscarInp = document.getElementById('post_buscar');
      const postBody = document.querySelector('#tablaPostulaciones tbody');
      const btnExportPost = document.getElementById('exportPostExcel');

      const applyPostFilter = () => {
        if (!postBody) return;
        const val = (postEstadoSel?.value || 'todos').toLowerCase();
        postBody.querySelectorAll('tr').forEach((tr) => {
          const estadoCell = tr.querySelector('td:nth-child(10)');
          const estado = (estadoCell?.textContent || '').trim().toLowerCase();
          tr.style.display = (val === 'todos' || estado === val) ? '' : 'none';
        });
      };

      postEstadoSel?.addEventListener('change', applyPostFilter);
      if (postBody) new MutationObserver(applyPostFilter).observe(postBody, { childList: true });

      btnExportPost?.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopImmediatePropagation();
        const q = (postBuscarInp?.value || '').trim();
        const estado = (postEstadoSel?.value || 'todos').toLowerCase();
        const params = new URLSearchParams();
        if (q) params.set('q', q);
        if (estado && estado !== 'todos') params.set('estado', estado);
        const url = `/api/admin/export/postulaciones.xlsx${params.toString() ? `?${params.toString()}` : ''}`;
        window.open(url, '_blank');
      }, true);

    } catch (_) {}

    // ===== Fix: Guardar en modal Editar (fallback handler) =====
    try {
      const enhancedReady = () => window.__dashboardAdminEnhancedReady === true;
      const getCookie = (name) => {
        const value = '; ' + document.cookie;
        const parts = value.split('; ' + name + '=');
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
      };
      const csrftoken = getCookie('csrftoken');
      const request = async (url, { method = 'GET', body = null } = {}) => {
        const headers = { 'X-Requested-With': 'XMLHttpRequest' };
        if (method !== 'GET') {
          headers['Content-Type'] = 'application/json';
          if (csrftoken) headers['X-CSRFToken'] = csrftoken;
        }
        const resp = await fetch(url, { method, headers, credentials: 'same-origin', body: body ? JSON.stringify(body) : null });
        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          throw new Error(text || ('HTTP ' + resp.status));
        }
        return resp.json().catch(() => ({}));
      };

      // Captura el id/rol al abrir editar (solo si el script principal no está listo)
      document.addEventListener('click', (ev) => {
        if (enhancedReady()) return;
        const btn = ev.target.closest('button[data-action="edit"]');
        if (!btn) return;
        const row = btn.closest('tr[data-id]');
        const modal = document.getElementById('modalEditar');
        if (row && modal) {
          modal.dataset.editId = row.getAttribute('data-id') || '';
          modal.dataset.isVendor = row.getAttribute('data-vendor') === '1' ? '1' : '0';
        }
      }, true);

      // Fallback guardar independiente
      const btnGuardar = document.getElementById('guardarEditar');
      btnGuardar?.addEventListener('click', async (ev) => {
        if (enhancedReady()) return;
        try {
          ev.preventDefault();
          ev.stopImmediatePropagation();
          const modal = document.getElementById('modalEditar');
          const id = Number(modal?.dataset.editId || '');
          if (!id) return;
          const username = (document.getElementById('editNombre')?.value || '').trim();
          const email = (document.getElementById('editEmail')?.value || '').trim();
          const pass = (document.getElementById('editPass')?.value || '').trim();
          const es_vendedor = (modal?.dataset.isVendor === '1');
          const body = { id, es_vendedor };
          if (username) body.username = username;
          body.email = email; // permite vacío
          if (pass) body.password = pass;
          await request('/api/admin/vendedores/', { method: 'PATCH', body });
          modal.style.display = 'none';
          setTimeout(() => location.reload(), 50);
        } catch (e) {
          console.error(e);
          let msg = (e && e.message ? e.message : '').trim();
          if (msg.startsWith('{')) {
            try {
              const parsed = JSON.parse(msg);
              msg = parsed.error || parsed.detail || msg;
            } catch (_) {}
          }
          alert(msg || 'No se pudo guardar.');
        }
      }, true);
    } catch (_) {}

  })();
  </script>
</body>
</html>



